---
interface Props {
  spotifyUri: string;
  height?: number;
  theme?: "dark" | "light";
}

const { spotifyUri, height = 352, theme = "dark" } = Astro.props;

// Convert Spotify URI to embed URL
// Supports: spotify:album:xxx, spotify:track:xxx, spotify:artist:xxx, spotify:playlist:xxx
// Or direct URLs: https://open.spotify.com/album/xxx
function getEmbedUrl(uri: string): string {
  // If it's already a URL
  if (uri.startsWith("https://open.spotify.com/")) {
    const parts = uri.replace("https://open.spotify.com/", "").split("/");
    const type = parts[0];
    const id = parts[1]?.split("?")[0];
    return `https://open.spotify.com/embed/${type}/${id}?utm_source=generator&theme=${theme === "dark" ? "0" : "1"}`;
  }

  // If it's a Spotify URI (spotify:album:xxx)
  if (uri.startsWith("spotify:")) {
    const parts = uri.split(":");
    const type = parts[1];
    const id = parts[2];
    return `https://open.spotify.com/embed/${type}/${id}?utm_source=generator&theme=${theme === "dark" ? "0" : "1"}`;
  }

  // Fallback - assume it's just an ID and type album
  return `https://open.spotify.com/embed/album/${uri}?utm_source=generator&theme=${theme === "dark" ? "0" : "1"}`;
}

const embedUrl = getEmbedUrl(spotifyUri);
---

<div class="spotify-embed-container">
  <iframe
    style={`border-radius:12px; height:${height}px;`}
    src={embedUrl}
    width="100%"
    height={height}
    frameBorder="0"
    allowfullscreen=""
    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
    loading="lazy"
    title="Spotify Player"
  ></iframe>

  <!-- Fallback for when iframe doesn't load -->
  <noscript>
    <div class="bg-band-dark-100 border border-band-gold/20 rounded-lg p-6 text-center">
      <p class="text-gray-400 mb-4">
        Habilita JavaScript para ver el reproductor de Spotify
      </p>
      <a
        href={spotifyUri.startsWith("https://") ? spotifyUri : `https://open.spotify.com`}
        target="_blank"
        rel="noopener noreferrer"
        class="btn-primary inline-flex items-center gap-2"
      >
        Abrir en Spotify
      </a>
    </div>
  </noscript>
</div>

<style>
  .spotify-embed-container {
    width: 100%;
    max-width: 100%;
  }

  .spotify-embed-container iframe {
    width: 100%;
  }
</style>
