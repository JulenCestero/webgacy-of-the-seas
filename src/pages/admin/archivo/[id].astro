---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { createDb, posts } from "../../../lib/db";
import { eq } from "drizzle-orm";


// Get runtime env from Cloudflare
const runtimeEnv = Astro.locals.runtime?.env as Record<string, string> | undefined;
const db = createDb(runtimeEnv);
const { id } = Astro.params;
let error = "";
let success = "";

const result = await db.select().from(posts).where(eq(posts.id, id!)).limit(1);
let post = result[0];

if (!post) {
  return Astro.redirect("/admin/archivo");
}

// Parse JSON arrays for display
function parseJsonArray(str: string | null): string[] {
  if (!str) return [];
  try {
    return JSON.parse(str);
  } catch {
    return [];
  }
}

const tagsArray = parseJsonArray(post.tags);
const galleryArray = parseJsonArray(post.gallery);

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();

    const title = formData.get("title") as string;
    const slug = formData.get("slug") as string;
    const date = formData.get("date") as string;
    const image = formData.get("image") as string || null;
    const excerpt = formData.get("excerpt") as string || null;
    const tagsStr = formData.get("tags") as string || "";
    const galleryStr = formData.get("gallery") as string || "";
    const body = formData.get("body") as string || null;

    const tags = tagsStr ? JSON.stringify(tagsStr.split(",").map(t => t.trim()).filter(Boolean)) : null;
    const gallery = galleryStr ? JSON.stringify(galleryStr.split("\n").map(t => t.trim()).filter(Boolean)) : null;

    if (!title || !slug || !date) {
      error = "Por favor, completa título, slug y fecha";
    } else {
      await db.update(posts)
        .set({ title, slug, date, image, excerpt, tags, gallery, body, updatedAt: new Date().toISOString() })
        .where(eq(posts.id, id!));

      success = "Post actualizado correctamente";
      const updated = await db.select().from(posts).where(eq(posts.id, id!)).limit(1);
      post = updated[0];
    }
  } catch (e) {
    error = "Error al actualizar: " + (e as Error).message;
  }
}

const formattedDate = post.date.split('T')[0];
---

<AdminLayout title="Editar post">
  <a href="/admin/archivo" class="back-link">
    <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </svg>
    Volver a archivo
  </a>

  <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h1 class="admin-title">Editar post</h1>
      <p class="admin-subtitle">{post.title}</p>
    </div>
    <a href={`/archivo/${post.slug}`} target="_blank" class="btn btn-secondary">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
      Ver en web
    </a>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {success && <div class="alert alert-success">{success}</div>}

  <form method="POST" style="max-width: 800px;">
    <!-- Información básica -->
    <div class="form-section">
      <div class="form-section-header">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3>Información básica</h3>
      </div>
      <div class="form-section-content">
        <div class="form-row">
          <div class="form-field">
            <label for="title">Título <span class="required">*</span></label>
            <input type="text" id="title" name="title" required value={post.title} />
          </div>
          <div class="form-field">
            <label for="slug">Slug (URL) <span class="required">*</span></label>
            <input type="text" id="slug" name="slug" required value={post.slug} />
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label for="date">Fecha <span class="required">*</span></label>
            <input type="date" id="date" name="date" required value={formattedDate} />
          </div>
          <div class="form-field">
            <label for="tags">Tags (separados por coma)</label>
            <input type="text" id="tags" name="tags" value={tagsArray.join(", ")} placeholder="noticias, album, concierto" />
          </div>
        </div>

        <div class="form-field">
          <label for="excerpt">Extracto / Resumen</label>
          <textarea id="excerpt" name="excerpt" rows="2" placeholder="Resumen corto del post...">{post.excerpt || ""}</textarea>
        </div>
      </div>
    </div>

    <!-- Imagen destacada -->
    <div class="form-section">
      <div class="form-section-header">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <h3>Imagen destacada</h3>
      </div>
      <div class="form-section-content">
        <input type="hidden" id="image" name="image" value={post.image || ""} />
        <div class="image-upload-container">
          <div class="image-preview-wrapper">
            {post.image ? (
              <img id="imagePreview" src={post.image} alt={post.title} class="image-preview" style="width: 250px; height: 150px;" />
            ) : (
              <div id="imagePreview" class="image-placeholder" style="width: 250px; height: 150px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span>Sin imagen</span>
              </div>
            )}
          </div>
          <div class="image-upload-actions">
            <label class="btn btn-secondary" style="cursor: pointer;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
              <span id="uploadBtnText">Subir imagen</span>
              <input type="file" id="imageFile" accept="image/*" style="display: none;" />
            </label>
            <button type="button" id="removeImage" class="btn btn-danger btn-sm" style="display: {post.image ? 'inline-flex' : 'none'};">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Eliminar
            </button>
          </div>
          <p id="uploadStatus" class="upload-status"></p>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <div class="form-section">
      <div class="form-section-header">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
        <h3>Contenido</h3>
        <span class="badge badge-info" style="margin-left: auto;">Markdown</span>
      </div>
      <div class="form-section-content">
        <div class="form-field">
          <label for="body">Contenido del post</label>
          <textarea id="body" name="body" rows="15" placeholder="Escribe el contenido del post en Markdown...">{post.body || ""}</textarea>
          <small class="form-hint">Puedes usar Markdown: **negrita**, *cursiva*, [enlaces](url), ## títulos, etc.</small>
        </div>
      </div>
    </div>

    <!-- Galería -->
    <div class="form-section">
      <div class="form-section-header">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <h3>Galería de imágenes</h3>
      </div>
      <div class="form-section-content">
        <div class="form-field">
          <label for="gallery">URLs de imágenes (una por línea)</label>
          <textarea id="gallery" name="gallery" rows="4" placeholder="/uploads/foto1.jpg
/uploads/foto2.jpg">{galleryArray.join("\n")}</textarea>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Guardar cambios
      </button>
      <a href="/admin/archivo" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>

  <!-- Danger zone -->
  <div class="danger-zone" style="max-width: 800px;">
    <div class="danger-zone-header">
      <div class="danger-zone-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </div>
      <div class="danger-zone-content">
        <h4>Zona peligrosa</h4>
        <p>Esta acción no se puede deshacer. El post se eliminará permanentemente.</p>
      </div>
    </div>
    <form method="POST" action="/admin/api/posts/delete">
      <input type="hidden" name="id" value={post.id} />
      <button type="submit" class="btn btn-danger" onclick="return confirm('¿Eliminar este post?')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        Eliminar post
      </button>
    </form>
  </div>
</AdminLayout>

<style>
  .image-upload-container {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .image-preview {
    object-fit: cover;
    border-radius: 0.5rem;
    border: 2px solid var(--admin-border);
  }

  .image-placeholder {
    border-radius: 0.5rem;
    border: 2px dashed var(--admin-border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: rgba(0, 0, 0, 0.2);
    color: var(--admin-muted);
    font-size: 0.75rem;
  }

  .image-upload-actions {
    display: flex;
    gap: 0.5rem;
  }
</style>

<script>
  const imageInput = document.getElementById('imageFile') as HTMLInputElement;
  const imageHidden = document.getElementById('image') as HTMLInputElement;
  const imagePreview = document.getElementById('imagePreview') as HTMLImageElement | HTMLDivElement;
  const uploadStatus = document.getElementById('uploadStatus') as HTMLParagraphElement;
  const uploadBtnText = document.getElementById('uploadBtnText') as HTMLSpanElement;
  const removeBtn = document.getElementById('removeImage') as HTMLButtonElement;

  imageInput?.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;

    uploadBtnText.textContent = 'Subiendo...';
    uploadStatus.textContent = '';
    uploadStatus.style.color = 'var(--admin-muted)';

    const formData = new FormData();
    formData.append('file', file);
    formData.append('folder', 'uploads/archivo');

    try {
      const response = await fetch('/admin/api/upload', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (response.ok) {
        imageHidden.value = result.url;

        // Update preview
        if (imagePreview.tagName === 'IMG') {
          (imagePreview as HTMLImageElement).src = result.url;
        } else {
          const img = document.createElement('img');
          img.id = 'imagePreview';
          img.src = result.url;
          img.className = 'image-preview';
          img.style.cssText = 'width: 200px; height: 120px;';
          imagePreview.parentNode?.replaceChild(img, imagePreview);
        }

        removeBtn.style.display = 'inline-flex';
        uploadStatus.textContent = 'Imagen subida correctamente';
        uploadStatus.style.color = 'var(--admin-success)';
      } else {
        uploadStatus.textContent = result.error || 'Error al subir imagen';
        uploadStatus.style.color = 'var(--admin-danger)';
      }
    } catch (err) {
      uploadStatus.textContent = 'Error de conexión';
      uploadStatus.style.color = 'var(--admin-danger)';
    }

    uploadBtnText.textContent = 'Subir imagen';
  });

  removeBtn?.addEventListener('click', () => {
    imageHidden.value = '';

    const placeholder = document.createElement('div');
    placeholder.id = 'imagePreview';
    placeholder.className = 'image-placeholder';
    placeholder.style.cssText = 'width: 200px; height: 120px;';
    placeholder.innerHTML = `
      <svg style="width: 32px; height: 32px; color: var(--admin-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      <span>Sin imagen</span>
    `;

    const currentPreview = document.getElementById('imagePreview');
    currentPreview?.parentNode?.replaceChild(placeholder, currentPreview);

    removeBtn.style.display = 'none';
    uploadStatus.textContent = '';
  });
</script>
